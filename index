import React, { useState } from 'react';
import { 
  Sparkles, 
  Moon, 
  Sun, 
  RotateCcw, 
  BookOpen, 
  User, 
  Loader2,
  RefreshCw
} from 'lucide-react';

// --- Tarot Deck Data ---
const TAROT_DECK = [
  { name: "The Fool", image: "ðŸƒ", meaning: "new beginnings and spontaneous leaps of faith", keyword: "Innocence" },
  { name: "The Magician", image: "ðŸª„", meaning: "the power of manifestation and using your innate tools", keyword: "Willpower" },
  { name: "The High Priestess", image: "ðŸŒ™", meaning: "the whispers of intuition and hidden knowledge", keyword: "Mystery" },
  { name: "The Empress", image: "ðŸŒ¿", meaning: "abundant creativity and nurturing energy", keyword: "Fertility" },
  { name: "The Emperor", image: "ðŸ‘‘", meaning: "structure, authority, and solid foundations", keyword: "Control" },
  { name: "The Hierophant", image: "â›ª", meaning: "tradition, spiritual wisdom, and cultural beliefs", keyword: "Belief" },
  { name: "The Lovers", image: "â¤ï¸", meaning: "harmony in relationships and value-based choices", keyword: "Union" },
  { name: "The Chariot", image: "ðŸ‡", meaning: "victory through willpower and focused determination", keyword: "Drive" },
  { name: "Strength", image: "ðŸ¦", meaning: "inner courage and the power of gentle persuasion", keyword: "Fortitude" },
  { name: "The Hermit", image: "ðŸ•¯ï¸", meaning: "introspection and the light of inner guidance", keyword: "Solitude" },
  { name: "Wheel of Fortune", image: "ðŸŽ¡", meaning: "the cycles of destiny and shifts in karma", keyword: "Luck" },
  { name: "Justice", image: "âš–ï¸", meaning: "fairness, truth, and the balance of cause and effect", keyword: "Truth" },
  { name: "The Hanged Man", image: "ðŸ¦¶", meaning: "surrender to the flow and gaining new perspectives", keyword: "Perspective" },
  { name: "Death", image: "ðŸ’€", meaning: "the closing of one door and the opening of another", keyword: "Transition" },
  { name: "Temperance", image: "ðŸ·", meaning: "patience, moderation, and the blending of opposites", keyword: "Balance" },
  { name: "The Devil", image: "ðŸ˜ˆ", meaning: "attachments that restrict your spiritual growth", keyword: "Shadow" },
  { name: "The Tower", image: "ðŸ°", meaning: "sudden upheaval that clears the way for truth", keyword: "Revelation" },
  { name: "The Star", image: "â­", meaning: "renewed hope and inspiration from the universe", keyword: "Hope" },
  { name: "The Moon", image: "ðŸŒ•", meaning: "navigating the shadows of the subconscious", keyword: "Subconscious" },
  { name: "The Sun", image: "ðŸŒž", meaning: "radiant success, joy, and absolute clarity", keyword: "Vitality" },
  { name: "Judgement", image: "ðŸŽº", meaning: "answering a higher calling and rebirth", keyword: "Calling" },
  { name: "The World", image: "ðŸŒ", meaning: "completion of a major cycle and fulfillment", keyword: "Wholeness" }
];

const ZODIAC_DATA = {
  "Aries": "fiery and impulsive spirit",
  "Taurus": "grounded and persistent nature",
  "Gemini": "dual and inquisitive mind",
  "Cancer": "deeply intuitive and emotional soul",
  "Leo": "radiant and courageous heart",
  "Virgo": "precise and analytical energy",
  "Libra": "harmonious and diplomatic essence",
  "Scorpio": "intense and transformative power",
  "Sagittarius": "adventurous and philosophical outlook",
  "Capricorn": "ambitious and disciplined resolve",
  "Aquarius": "original and visionary perspective",
  "Pisces": "dreamy and empathetic connection"
};

const ZODIAC_SIGNS = Object.keys(ZODIAC_DATA);

export default function App() {
  const [selectedSign, setSelectedSign] = useState(null);
  const [step, setStep] = useState('sign-selection'); 
  const [drawnCards, setDrawnCards] = useState([]);
  const [readingText, setReadingText] = useState("");
  const [isLoadingReading, setIsLoadingReading] = useState(false);
  const [deck] = useState([...TAROT_DECK]);

  const handleDrawCard = (index) => {
    if (drawnCards.length >= 3) return;
    const card = deck[index % deck.length];
    if (drawnCards.find(c => c.name === card.name)) return;
    setDrawnCards(prev => [...prev, card]);
  };

  const autoDraw = () => {
    const shuffled = [...TAROT_DECK].sort(() => Math.random() - 0.5);
    setDrawnCards(shuffled.slice(0, 3));
  };

  const generateLocalReading = () => {
    setIsLoadingReading(true);
    setStep('interpretation');

    // Simulate "Consulting the Stars" delay for immersion
    setTimeout(() => {
      const [past, present, future] = drawnCards;
      const zodiacTrait = ZODIAC_DATA[selectedSign];

      const intro = `As a ${selectedSign}, your ${zodiacTrait} is currently reacting to the cosmic alignment. `;
      
      const pastPart = `In the recent past, ${past.name} indicated a period characterized by ${past.meaning}. This established the foundation for your current path. `;
      
      const presentPart = `Right now, ${present.name} suggests you are navigating ${present.meaning}. For a ${selectedSign}, this requires you to lean into your natural strength. `;
      
      const futurePart = `Looking ahead, ${future.name} promises ${future.meaning}. This transition will be pivotal for your spiritual evolution. `;
      
      const advice = `Trust in your ${selectedSign} intuition as you integrate these energies.`;

      setReadingText(intro + pastPart + presentPart + futurePart + advice);
      setIsLoadingReading(false);
    }, 1500);
  };

  const reset = () => {
    setStep('sign-selection');
    setDrawnCards([]);
    setReadingText("");
    setSelectedSign(null);
  };

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans selection:bg-amber-500/30">
      <div className="fixed inset-0 pointer-events-none overflow-hidden">
        <div className="absolute top-[-10%] left-[-10%] w-[40%] h-[40%] bg-indigo-900/20 blur-[120px] rounded-full"></div>
        <div className="absolute bottom-[-10%] right-[-10%] w-[40%] h-[40%] bg-purple-900/20 blur-[120px] rounded-full"></div>
      </div>

      <header className="relative z-10 p-6 flex items-center justify-between border-b border-white/10 backdrop-blur-md sticky top-0">
        <div className="flex items-center gap-2">
          <div className="w-10 h-10 bg-gradient-to-br from-indigo-500 to-purple-600 rounded-lg flex items-center justify-center shadow-lg shadow-indigo-500/20">
            <Sparkles className="text-white" size={20} />
          </div>
          <h1 className="text-xl font-serif font-bold tracking-tight">Stellar Tarot</h1>
        </div>
        {selectedSign && (
          <div className="flex items-center gap-2 bg-white/5 px-3 py-1.5 rounded-full border border-white/10">
            <User size={14} className="text-amber-400" />
            <span className="text-xs font-medium uppercase tracking-widest">{selectedSign}</span>
          </div>
        )}
      </header>

      <main className="relative z-10 max-w-4xl mx-auto p-6 pb-24">
        
        {step === 'sign-selection' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
            <div className="text-center space-y-2">
              <h2 className="text-3xl font-serif">Welcome, seeker</h2>
              <p className="text-slate-400">Select your zodiac sign to begin your journey.</p>
            </div>
            <div className="grid grid-cols-3 sm:grid-cols-4 gap-3">
              {ZODIAC_SIGNS.map(sign => (
                <button
                  key={sign}
                  onClick={() => { setSelectedSign(sign); setStep('shuffling'); }}
                  className="p-4 rounded-2xl bg-white/5 border border-white/10 hover:border-amber-500/50 hover:bg-white/10 transition-all text-sm font-medium flex flex-col items-center gap-2 active:scale-95"
                >
                  <Sun size={18} className="text-amber-500" />
                  {sign}
                </button>
              ))}
            </div>
          </div>
        )}

        {step === 'shuffling' && (
          <div className="space-y-8 animate-in fade-in duration-500">
            <div className="flex justify-between items-end">
              <div>
                <h2 className="text-2xl font-serif">Draw Your Path</h2>
                <p className="text-slate-400 text-sm">Select 3 cards for Past, Present, and Future.</p>
              </div>
              <button 
                onClick={autoDraw}
                className="flex items-center gap-2 text-amber-400 text-sm font-medium hover:underline"
              >
                <RefreshCw size={14} /> Auto-Draw
              </button>
            </div>

            <div className="flex justify-center gap-4 min-h-[160px] md:min-h-[220px]">
              {[0, 1, 2].map((i) => (
                <div key={i} className="flex flex-col items-center gap-2">
                  <div className="w-24 h-36 md:w-32 md:h-48 rounded-xl border-2 border-dashed border-white/10 flex items-center justify-center relative">
                    {drawnCards[i] ? (
                      <div className="bg-white rounded-lg p-2 text-indigo-900 w-full h-full flex flex-col items-center justify-center animate-in zoom-in-95 duration-300 shadow-xl border-2 border-amber-500 overflow-hidden">
                        <span className="text-4xl">{drawnCards[i].image}</span>
                        <span className="text-[10px] uppercase font-bold text-center mt-2 leading-tight">{drawnCards[i].name}</span>
                        <div className="absolute top-1 right-1 opacity-10"><Sparkles size={12} /></div>
                      </div>
                    ) : (
                      <span className="text-white/20 text-[10px] uppercase tracking-tighter">
                        {i === 0 ? "Past" : i === 1 ? "Present" : "Future"}
                      </span>
                    )}
                  </div>
                </div>
              ))}
            </div>

            {drawnCards.length < 3 ? (
              <div className="relative h-48 flex items-center justify-center overflow-x-auto py-4">
                <div className="flex -space-x-12 px-12">
                  {[...Array(15)].map((_, i) => (
                    <div 
                      key={i}
                      onClick={() => handleDrawCard(i)}
                      className="w-24 h-36 md:w-32 md:h-48 bg-indigo-950 rounded-xl border border-amber-400/30 shadow-2xl hover:-translate-y-4 transition-transform cursor-pointer flex-shrink-0 flex items-center justify-center group"
                      style={{ transform: `rotate(${(i - 7) * 2}deg)` }}
                    >
                      <Moon className="text-amber-500/20 group-hover:text-amber-500/50 transition-colors" size={24} />
                    </div>
                  ))}
                </div>
              </div>
            ) : (
              <div className="flex justify-center pt-8">
                <button
                  onClick={generateLocalReading}
                  className="bg-gradient-to-r from-amber-500 to-orange-600 text-white px-12 py-4 rounded-full font-bold shadow-xl shadow-amber-500/20 hover:scale-105 active:scale-95 transition-all flex items-center gap-3"
                >
                  <BookOpen size={20} />
                  Reveal Meaning
                </button>
              </div>
            )}
          </div>
        )}

        {step === 'interpretation' && (
          <div className="space-y-8 animate-in fade-in slide-in-from-bottom-8 duration-1000">
            <div className="text-center space-y-2">
              <span className="text-amber-500 text-xs font-bold uppercase tracking-widest">Alignment for {selectedSign}</span>
              <h2 className="text-3xl font-serif">The Cosmic Reading</h2>
            </div>

            <div className="grid grid-cols-3 gap-3 md:gap-6">
              {drawnCards.map((card, i) => (
                <div key={i} className="bg-white/5 rounded-2xl p-4 border border-white/10 text-center space-y-2">
                  <div className="text-[10px] text-amber-500 font-bold uppercase tracking-widest">
                    {i === 0 ? "Past" : i === 1 ? "Present" : "Future"}
                  </div>
                  <div className="text-3xl">{card.image}</div>
                  <div className="text-xs font-serif font-bold text-slate-300">{card.name}</div>
                </div>
              ))}
            </div>

            <div className="bg-white/5 backdrop-blur-md rounded-3xl p-6 md:p-10 border border-white/10 shadow-inner relative overflow-hidden">
              <div className="absolute top-0 right-0 p-4 text-white/5">
                <Sparkles size={120} />
              </div>
              
              {isLoadingReading ? (
                <div className="flex flex-col items-center justify-center py-12 space-y-4">
                  <Loader2 className="animate-spin text-amber-500" size={40} />
                  <p className="text-slate-400 animate-pulse font-serif italic text-lg text-center">Consulting your stars...</p>
                </div>
              ) : (
                <div className="space-y-6 relative z-10">
                  <p className="text-slate-200 leading-relaxed text-lg font-serif first-letter:text-4xl first-letter:font-bold first-letter:text-amber-500 first-letter:mr-1 first-letter:float-left text-justify">
                    {readingText}
                  </p>
                  <div className="h-px bg-gradient-to-r from-transparent via-white/20 to-transparent w-full"></div>
                  <div className="flex justify-between items-center">
                    <button 
                      onClick={reset}
                      className="flex items-center gap-2 text-slate-400 hover:text-white transition-colors"
                    >
                      <RotateCcw size={16} />
                      <span className="text-sm">New Reading</span>
                    </button>
                    <div className="text-[10px] uppercase tracking-widest text-white/30 font-bold">
                      Stellar Tarot v1.0
                    </div>
                  </div>
                </div>
              )}
            </div>
          </div>
        )}
      </main>
    </div>
  );
}
